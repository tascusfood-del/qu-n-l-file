<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hệ Thống Quy Trình Cửa Hàng</title>
    
    <!-- 1. Cài đặt Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. Cài đặt React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- 3. Cài đặt Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- 4. Cài đặt Icon (Lucide) -->
    <script src="https://unpkg.com/lucide-react@0.294.0/dist/umd/lucide-react.min.js"></script>

    <style>
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        @keyframes fade-in { from { opacity: 0; } to { opacity: 1; } }
        .animate-in { animation: fade-in 0.3s ease-out; }
    </style>
</head>
<body class="bg-slate-50">
    <!-- Nơi hiển thị lỗi nếu Web bị trắng -->
    <div id="error-trap" style="display:none; padding: 20px; color: red; background: #fff0f0; border: 1px solid red; margin: 20px;">
        <h3 style="font-weight: bold;">⚠️ Ứng dụng gặp lỗi khởi động:</h3>
        <pre id="error-msg" style="white-space: pre-wrap; margin-top: 10px;"></pre>
        <p style="margin-top: 10px; color: #555;">Hãy thử tải lại trang (F5). Nếu vẫn bị, hãy chụp màn hình này gửi cho kỹ thuật.</p>
    </div>

    <div id="root"></div>

    <script>
        // Bắt lỗi toàn cục để hiển thị lên màn hình thay vì trắng xoá
        window.onerror = function(message, source, lineno, colno, error) {
            document.getElementById('error-trap').style.display = 'block';
            document.getElementById('error-msg').textContent = message + '\nTại dòng: ' + lineno;
        };
    </script>

    <script type="text/babel">
        // Kiểm tra thư viện trước khi chạy
        if (typeof React === 'undefined' || typeof ReactDOM === 'undefined' || typeof lucideReact === 'undefined') {
            throw new Error("Không thể tải thư viện React hoặc Lucide. Vui lòng kiểm tra kết nối mạng.");
        }

        const { useState, useEffect, useMemo, useRef } = React;
        const { 
            Search, FolderOpen, FileText, Eye, Grid, List, X, Download, 
            Trash2, RefreshCw, Tag, Edit2, Link: LinkIcon, Lock, 
            ExternalLink, Folder, Copy, Table, CheckCircle, 
            AlertTriangle, FileWarning, RefreshCcw 
        } = lucideReact;

        // --- Helper: Login Screen ---
        const LoginScreen = ({ onLogin }) => {
            const [password, setPassword] = useState('');
            const [error, setError] = useState(false);

            const handleLogin = (e) => {
                e.preventDefault();
                if (password === '123456' || password === 'admin') {
                    onLogin();
                } else {
                    setError(true);
                }
            };

            return (
                <div className="fixed inset-0 z-[100] bg-slate-900 flex items-center justify-center p-4">
                    <div className="bg-white w-full max-w-md p-8 rounded-2xl shadow-2xl animate-in">
                        <div className="flex justify-center mb-6">
                            <div className="bg-blue-100 p-4 rounded-full">
                                <Lock className="text-blue-600" size={32} />
                            </div>
                        </div>
                        <h2 className="text-2xl font-bold text-center text-slate-800 mb-2">Đăng nhập hệ thống</h2>
                        <p className="text-center text-slate-500 mb-6">Nhập mật khẩu để truy cập quy trình</p>
                        <form onSubmit={handleLogin} className="space-y-4">
                            <div>
                                <input type="password" value={password} onChange={(e) => {setPassword(e.target.value); setError(false);}} className="w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition" placeholder="Mật khẩu (Gợi ý: admin)" autoFocus />
                                {error && <p className="text-red-500 text-sm mt-2">Mật khẩu không đúng.</p>}
                            </div>
                            <button type="submit" className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg transition shadow-lg shadow-blue-200">Mở khóa</button>
                        </form>
                    </div>
                </div>
            );
        };

        // --- Helper Functions ---
        const analyzeLinkType = (url) => {
            if (!url || !url.startsWith('http')) return 'error';
            if (url.includes('id=') || url.includes('preview=') || url.includes('open=')) return 'file-link';
            if (url.includes('/folders/') || url.includes('/drive/u/') || url.includes('drive.google.com/drive/folders')) return 'folder-link';
            return 'file-link';
        };

        const getDriveId = (url) => {
            if (!url) return null;
            // Tìm ID trong param id=
            const idParamMatch = url.match(/[?&]id=([a-zA-Z0-9-_]+)/);
            if (idParamMatch && idParamMatch[1]) return idParamMatch[1];
            // Tìm ID trong path /d/
            const pathIdMatch = url.match(/\/d\/([a-zA-Z0-9-_]+)/);
            if (pathIdMatch && pathIdMatch[1]) return pathIdMatch[1];
            return null;
        };

        // --- Components ---
        const AddLinkModal = ({ isOpen, onClose, onAdd, onAddBulk, onSyncSheet }) => {
            const [mode, setMode] = useState('single'); 
            const [name, setName] = useState('');
            const [url, setUrl] = useState('');
            const [category, setCategory] = useState('');
            const [bulkText, setBulkText] = useState('');
            const [sheetUrl, setSheetUrl] = useState('');
            const [isFetchingSheet, setIsFetchingSheet] = useState(false);

            if (!isOpen) return null;

            const handleSingleSubmit = () => {
                if (name && url) {
                    if (!url.startsWith('http')) { alert("Link phải bắt đầu bằng http:// hoặc https://"); return; }
                    onAdd({ name, url, category: category.toUpperCase() || 'LINK', type: analyzeLinkType(url) });
                    resetForm(); onClose();
                }
            };

            const handleBulkSubmit = () => {
                if (!bulkText.trim()) return;
                const lines = bulkText.split('\n');
                const newItems = [];
                lines.forEach(line => {
                    const parts = line.split('|').map(p => p.trim());
                    if (parts.length >= 2 && parts[1].startsWith('http')) {
                        newItems.push({
                            id: `l-bulk-${Date.now()}-${Math.random()}`,
                            name: parts[0], url: parts[1],
                            category: (parts[2] || 'NHAP_NHANH').toUpperCase(),
                            isLink: true, linkType: analyzeLinkType(parts[1]),
                            size: 0, lastModified: Date.now()
                        });
                    }
                });
                onAddBulk(newItems); resetForm(); onClose();
            };

            // Hàm parse CSV tốt hơn cho tiếng Việt
            const parseCSVLine = (text) => {
                const re_value = /(?!\s*$)\s*(?:'([^'\\]*(?:\\[\S\s][^'\\]*)*)'|"([^"\\]*(?:\\[\S\s][^"\\]*)*)"|([^,'"\s\\]*(?:\s+[^,'"\s\\]+)*))\s*(?:,|$)/g;
                const a = [];
                text.replace(re_value, function(m0, m1, m2, m3) {
                    if (m1 !== undefined) a.push(m1.replace(/\\'/g, "'"));
                    else if (m2 !== undefined) a.push(m2.replace(/\\"/g, '"'));
                    else if (m3 !== undefined) a.push(m3);
                    return '';
                });
                if (/,\s*$/.test(text)) a.push('');
                return a;
            };

            const handleSheetSubmit = async () => {
                if (!sheetUrl.trim()) return;
                setIsFetchingSheet(true);
                try {
                    const match = sheetUrl.match(/\/d\/([a-zA-Z0-9-_]+)/);
                    if (!match) { alert("Link Sheet không hợp lệ."); setIsFetchingSheet(false); return; }
                    const csvUrl = `https://docs.google.com/spreadsheets/d/${match[1]}/export?format=csv`;
                    const res = await fetch(csvUrl);
                    if (!res.ok) throw new Error("Không thể đọc Sheet. Hãy chắc chắn đã Share 'Anyone with the link'.");
                    const text = await res.text();
                    const rows = text.split(/\r?\n/).slice(1);
                    const newItems = [];
                    
                    rows.forEach(row => {
                        let cols = parseCSVLine(row);
                        if (!cols || cols.length === 0) cols = row.split(',').map(c => c.trim());
                        if (cols.length >= 3 && cols[0]) {
                            const link = cols[2]?.replace(/^"|"$/g, '').trim();
                            if (link && link.startsWith('http')) {
                                newItems.push({
                                    id: `l-sheet-${Date.now()}-${Math.random()}`,
                                    name: cols[0].replace(/^"|"$/g, '').trim(),
                                    url: link,
                                    category: (cols[1]?.replace(/^"|"$/g, '').trim() || 'SHEET').toUpperCase(),
                                    isLink: true, linkType: analyzeLinkType(link),
                                    size: 0, lastModified: Date.now(),
                                    sourceSheet: sheetUrl
                                });
                            }
                        }
                    });
                    
                    onSyncSheet(sheetUrl, newItems);
                    alert(`Đồng bộ thành công ${newItems.length} mục!`);
                    resetForm(); onClose();
                } catch (e) { alert(e.message); } finally { setIsFetchingSheet(false); }
            };

            const resetForm = () => { setName(''); setUrl(''); setCategory(''); setBulkText(''); setSheetUrl(''); };

            return (
                <div className="fixed inset-0 z-[60] flex items-center justify-center bg-black/50 backdrop-blur-sm p-4 animate-in">
                    <div className="bg-white w-full max-w-lg rounded-xl shadow-xl overflow-hidden flex flex-col max-h-[90vh]">
                        <div className="flex border-b border-slate-200">
                            <button className={`flex-1 py-3 font-medium text-xs sm:text-sm flex justify-center items-center gap-1 ${mode === 'single' ? 'text-blue-600 border-b-2 border-blue-600' : 'text-slate-500'}`} onClick={() => setMode('single')}><LinkIcon size={14}/> 1 Link</button>
                            <button className={`flex-1 py-3 font-medium text-xs sm:text-sm flex justify-center items-center gap-1 ${mode === 'sheet' ? 'text-green-600 border-b-2 border-green-600' : 'text-slate-500'}`} onClick={() => setMode('sheet')}><Table size={14}/> Google Sheet (Sync)</button>
                            <button className={`flex-1 py-3 font-medium text-xs sm:text-sm flex justify-center items-center gap-1 ${mode === 'bulk' ? 'text-slate-600 border-b-2 border-slate-600' : 'text-slate-500'}`} onClick={() => setMode('bulk')}><Copy size={14}/> Copy Paste</button>
                        </div>
                        <div className="p-6 overflow-y-auto">
                            {mode === 'single' && <div className="space-y-4">
                                <input className="w-full p-2.5 border rounded-lg" value={name} onChange={e => setName(e.target.value)} placeholder="Tên quy trình" />
                                <input className="w-full p-2.5 border rounded-lg" value={url} onChange={e => setUrl(e.target.value)} placeholder="Link Drive (https://...)" />
                                <input className="w-full p-2.5 border rounded-lg uppercase" value={category} onChange={e => setCategory(e.target.value)} placeholder="Tag (VD: KHO)" />
                            </div>}
                            {mode === 'sheet' && <div className="space-y-4">
                                <div className="bg-green-50 p-3 rounded text-sm text-green-800"><RefreshCcw size={14} className="inline mr-1"/> Chế độ Sync: Nhập link Sheet để đồng bộ lại toàn bộ danh sách từ Sheet đó.</div>
                                <input className="w-full p-3 border rounded-lg" value={sheetUrl} onChange={e => setSheetUrl(e.target.value)} placeholder="Link Google Sheet..." />
                            </div>}
                            {mode === 'bulk' && <textarea className="w-full p-3 border rounded-lg h-32 text-sm" placeholder="Tên | Link | Tag" value={bulkText} onChange={e => setBulkText(e.target.value)}></textarea>}
                        </div>
                        <div className="p-4 border-t bg-slate-50 flex justify-end gap-2">
                            <button onClick={onClose} className="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-lg">Hủy</button>
                            <button onClick={mode === 'single' ? handleSingleSubmit : mode === 'sheet' ? handleSheetSubmit : handleBulkSubmit} disabled={isFetchingSheet} className="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">{isFetchingSheet ? 'Đang chạy...' : 'Thực hiện'}</button>
                        </div>
                    </div>
                </div>
            );
        };

        const EditModal = ({ file, isOpen, onClose, onSave }) => {
            const [tags, setTags] = useState('');
            const [link, setLink] = useState('');
            useEffect(() => { if(file) { setTags(file.category || ''); setLink(file.url || ''); } }, [file]);
            if (!isOpen || !file) return null;
            return (
                <div className="fixed inset-0 z-[60] flex items-center justify-center bg-black/50 backdrop-blur-sm p-4 animate-in">
                    <div className="bg-white w-full max-w-md rounded-xl shadow-xl p-6">
                        <h3 className="text-lg font-bold mb-4">Sửa thông tin</h3>
                        <div className="mb-4"><label className="text-xs text-slate-500">Tag</label><input type="text" value={tags} onChange={e=>setTags(e.target.value)} className="w-full p-2 border rounded uppercase"/></div>
                        {file.isLink && <div className="mb-4"><label className="text-xs text-slate-500">Link</label><input type="text" value={link} onChange={e=>setLink(e.target.value)} className="w-full p-2 border rounded"/></div>}
                        <div className="flex justify-end gap-2"><button onClick={onClose} className="px-4 py-2 text-slate-600">Hủy</button><button onClick={()=>onSave(file.id, tags, link)} className="px-4 py-2 bg-blue-600 text-white rounded">Lưu</button></div>
                    </div>
                </div>
            );
        };

        const PdfViewer = ({ file }) => {
            const canvasRef = useRef(null);
            const [pageNum, setPageNum] = useState(1);
            const [pdfDoc, setPdfDoc] = useState(null);
            const [scale, setScale] = useState(1.5);
            
            useEffect(() => {
                if(!window.pdfjsLib) return;
                window.pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
                file.arrayBuffer().then(data => window.pdfjsLib.getDocument({data}).promise).then(doc => { setPdfDoc(doc); setPageNum(1); });
            }, [file]);

            useEffect(() => {
                if(pdfDoc && canvasRef.current) {
                    pdfDoc.getPage(pageNum).then(page => {
                        const viewport = page.getViewport({ scale });
                        const canvas = canvasRef.current;
                        const context = canvas.getContext('2d');
                        canvas.height = viewport.height; canvas.width = viewport.width;
                        page.render({ canvasContext: context, viewport }).promise;
                    });
                }
            }, [pdfDoc, pageNum, scale]);

            if(!pdfDoc) return <div className="text-center p-4 text-white">Đang tải PDF...</div>;
            return (
                <div className="flex flex-col items-center w-full h-full bg-slate-500 overflow-y-auto p-4">
                    <div className="sticky top-0 z-10 bg-slate-800 text-white p-2 rounded-lg mb-4 flex gap-4 shadow-lg">
                        <button onClick={()=>setPageNum(p=>Math.max(1, p-1))} disabled={pageNum<=1}>&lt;</button>
                        <span>{pageNum} / {pdfDoc.numPages}</span>
                        <button onClick={()=>setPageNum(p=>Math.min(pdfDoc.numPages, p+1))} disabled={pageNum>=pdfDoc.numPages}>&gt;</button>
                    </div>
                    <canvas ref={canvasRef} className="shadow-2xl rounded-sm max-w-full"/>
                </div>
            );
        };

        const FilePreviewModal = ({ file, onClose }) => {
            const containerRef = useRef(null);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);

            const getEmbedUrl = (url) => {
                if (!url || !url.startsWith('http')) return null;
                const fileId = getDriveId(url);
                if (!fileId && (url.includes('/folders/') || url.includes('/drive/u/'))) return null;
                if (fileId) {
                    if (url.includes('spreadsheets')) return `https://docs.google.com/spreadsheets/d/${fileId}/preview`;
                    if (url.includes('document')) return `https://docs.google.com/document/d/${fileId}/preview`;
                    return `https://drive.google.com/file/d/${fileId}/preview`;
                }
                return url.replace(/\/view.*/, '/preview').replace(/\/edit.*/, '/preview').replace(/\/open.*/, '/preview').replace(/\/copy.*/, '/preview');
            };

            const embedUrl = file.isLink ? getEmbedUrl(file.url) : null;
            const isFolder = file.isLink && (!embedUrl || file.linkType === 'folder');
            
            useEffect(() => {
                if (file.isLink) { setLoading(false); return; }
                const loadFile = async () => {
                    try {
                        const ext = file.name.split('.').pop().toLowerCase();
                        if (ext === 'pdf' || file.name.endsWith('.pdf')) { setLoading(false); return; }
                        if (ext === 'docx' && window.docx) {
                            containerRef.current.innerHTML = '';
                            await window.docx.renderAsync(file, containerRef.current, null, {inWrapper:false, ignoreWidth:false});
                            setLoading(false);
                        } else if (['xlsx','xls','csv'].includes(ext) && window.XLSX) {
                            const data = new Uint8Array(await file.arrayBuffer());
                            const wb = window.XLSX.read(data, {type:'array'});
                            const html = window.XLSX.utils.sheet_to_html(wb.Sheets[wb.SheetNames[0]]);
                            containerRef.current.innerHTML = `<div style="padding:20px; background:white;">${html}</div>`;
                            setLoading(false);
                        } else { setError("Không hỗ trợ xem trước"); setLoading(false); }
                    } catch(e) { setError(e.message); setLoading(false); }
                };
                setTimeout(loadFile, 100);
            }, [file]);

            const isPdf = !file.isLink && file.name.toLowerCase().endsWith('.pdf');

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/80 p-4 animate-in">
                    <div className="bg-white w-full h-full max-w-[95vw] max-h-[95vh] rounded-xl shadow-2xl flex flex-col overflow-hidden">
                        <div className="flex justify-between items-center px-4 py-3 bg-slate-100 border-b">
                            <h3 className="font-bold truncate max-w-md">{file.name}</h3>
                            <div className="flex gap-2">
                                {file.isLink && <a href={file.url} target="_blank" className="px-3 py-1.5 bg-blue-100 text-blue-700 rounded text-sm flex items-center gap-1"><ExternalLink size={14}/> Mở Tab Mới</a>}
                                <button onClick={onClose} className="p-2 hover:bg-red-100 rounded"><X size={22}/></button>
                            </div>
                        </div>
                        <div className="flex-1 bg-slate-200 relative overflow-hidden flex flex-col">
                            {loading && <div className="absolute inset-0 flex items-center justify-center bg-white/50 z-10">Loading...</div>}
                            {file.isLink ? (
                                isFolder ? <div className="flex flex-col items-center justify-center h-full"><h3 className="text-xl font-bold mb-4">Link Thư Mục</h3><a href={file.url} target="_blank" className="bg-blue-600 text-white px-6 py-2 rounded">Mở Thư Mục</a></div> :
                                <iframe src={embedUrl} className="w-full h-full border-none" title="Preview"></iframe>
                            ) : error ? <div className="flex items-center justify-center h-full text-red-500">{error}</div> : isPdf ? <PdfViewer file={file}/> : <div ref={containerRef} className="w-full h-full overflow-y-auto bg-slate-100 p-8 docx-wrapper"></div>}
                        </div>
                    </div>
                </div>
            );
        };

        const ProcessManager = () => {
            const [isAuthenticated, setIsAuthenticated] = useState(false);
            const [files, setFiles] = useState([]);
            const [searchQuery, setSearchQuery] = useState('');
            const [viewMode, setViewMode] = useState('list');
            const [previewFile, setPreviewFile] = useState(null);
            const [activeCategory, setActiveCategory] = useState('all');
            const [modals, setModals] = useState({ edit: false, link: false });
            const [editingFile, setEditingFile] = useState(null);
            const replaceInputRef = useRef(null);
            const [replacingId, setReplacingId] = useState(null);

            useEffect(() => {
                ["https://unpkg.com/jszip/dist/jszip.min.js", "https://unpkg.com/docx-preview/dist/docx-preview.min.js", "https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js", "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"].forEach(src => {
                    const s = document.createElement('script'); s.src = src; document.body.appendChild(s);
                });
            }, []);

            const mergeFiles = (newFiles) => {
                setFiles(prev => {
                    const next = [...prev];
                    newFiles.forEach(nf => {
                        const idx = next.findIndex(f => (nf.isLink && f.isLink && f.url === nf.url) || (!nf.isLink && !f.isLink && f.name === nf.name));
                        if(idx !== -1) next[idx] = { ...nf, id: next[idx].id, category: nf.category === 'CHUNG' ? next[idx].category : nf.category };
                        else next.push(nf);
                    });
                    return next;
                });
            };

            const syncSheet = (url, items) => {
                setFiles(prev => [...prev.filter(f => f.sourceSheet !== url), ...items]);
            };

            const handleDownload = (e, file) => {
                e.stopPropagation();
                if (file.isLink) {
                    const id = getDriveId(file.url);
                    window.open(id ? `https://drive.google.com/uc?export=download&id=${id}` : file.url, '_blank');
                } else {
                    const u = URL.createObjectURL(file);
                    const a = document.createElement('a'); a.href = u; a.download = file.name;
                    document.body.appendChild(a); a.click(); document.body.removeChild(a);
                }
            };

            const handleDelete = (e, id) => {
                e.preventDefault(); e.stopPropagation();
                if(window.confirm("Xóa file này?")) {
                    setFiles(p => p.filter(f => f.id !== id));
                    if(previewFile?.id === id) setPreviewFile(null);
                }
            };

            // Replace logic
            const onReplace = (e) => {
                const f = e.target.files[0];
                if(f && replacingId) {
                    setFiles(prev => prev.map(old => old.id === replacingId ? {...f, id: old.id, category: old.category} : old));
                    alert("Đã thay thế file!");
                }
                setReplacingId(null); e.target.value = null;
            };

            const filtered = useMemo(() => files.filter(f => 
                (activeCategory === 'all' || f.category === activeCategory) && 
                f.name.toLowerCase().includes(searchQuery.toLowerCase())
            ), [files, searchQuery, activeCategory]);

            const cats = useMemo(() => ['all', ...new Set(files.map(f => f.category))].sort(), [files]);

            if(!isAuthenticated) return <LoginScreen onLogin={() => setIsAuthenticated(true)}/>;

            return (
                <div className="min-h-screen bg-slate-50 text-slate-800 font-sans pb-10">
                    <input type="file" ref={replaceInputRef} className="hidden" onChange={onReplace} accept=".docx,.pdf,.xlsx,.xls,.csv"/>
                    
                    <header className="bg-white border-b sticky top-0 z-30 shadow-sm px-4 h-16 flex items-center justify-between gap-4">
                        <div className="flex items-center gap-2 font-bold text-lg"><FileText className="text-blue-600"/> Quản Lý Quy Trình</div>
                        <div className="flex-1 max-w-xl relative">
                            <Search className="absolute left-3 top-3 text-slate-400" size={18}/>
                            <input className="w-full pl-10 pr-4 py-2 bg-slate-100 rounded-lg outline-none focus:ring-2 focus:ring-blue-500" placeholder="Tìm kiếm..." value={searchQuery} onChange={e=>setSearchQuery(e.target.value)}/>
                        </div>
                        <div className="flex gap-2">
                            <button onClick={()=>setModals({...modals, link:true})} className="bg-purple-100 text-purple-700 px-3 py-2 rounded-lg text-sm font-medium flex items-center gap-2 hover:bg-purple-200"><LinkIcon size={16}/> Thêm Link</button>
                            <label className="cursor-pointer bg-blue-600 text-white px-3 py-2 rounded-lg text-sm font-medium flex items-center gap-2 hover:bg-blue-700">
                                <FolderOpen size={16}/> Upload PC
                                <input type="file" multiple className="hidden" onChange={e => {
                                    const fs = Array.from(e.target.files).map((f,i) => { f.id = `f-${Date.now()}-${i}`; f.category='CHUNG'; return f; });
                                    mergeFiles(fs);
                                }}/>
                            </label>
                            <div className="flex bg-slate-100 p-1 rounded-lg">
                                <button onClick={()=>setViewMode('list')} className={`p-2 rounded ${viewMode==='list'?'bg-white shadow text-blue-600':'text-slate-500'}`}><List size={18}/></button>
                                <button onClick={()=>setViewMode('grid')} className={`p-2 rounded ${viewMode==='grid'?'bg-white shadow text-blue-600':'text-slate-500'}`}><Grid size={18}/></button>
                            </div>
                        </div>
                    </header>

                    <main className="max-w-7xl mx-auto px-4 py-6 flex gap-6 flex-col md:flex-row items-start">
                        {files.length === 0 ? (
                            <div className="w-full text-center py-20 text-slate-400">
                                <FolderOpen size={64} className="mx-auto mb-4 text-blue-200"/>
                                <h2 className="text-xl text-slate-600 font-bold">Chưa có quy trình nào</h2>
                                <p>Hãy nhấn nút Upload hoặc Thêm Link ở góc trên.</p>
                            </div>
                        ) : (
                            <>
                                <aside className="w-full md:w-56 bg-white p-3 rounded-xl shadow-sm border border-slate-200 sticky top-20 max-h-[80vh] overflow-y-auto">
                                    <h3 className="font-bold text-slate-700 mb-3 flex items-center gap-2"><Tag size={16}/> Danh mục</h3>
                                    {cats.map(c => (
                                        <button key={c} onClick={()=>setActiveCategory(c)} className={`w-full text-left px-3 py-2 rounded mb-1 text-sm flex justify-between ${activeCategory===c ? 'bg-blue-600 text-white' : 'hover:bg-slate-50 text-slate-600'}`}>
                                            <span className="truncate">{c==='all'?'Tất cả':c}</span>
                                            <span className="opacity-70 bg-black/10 px-1.5 rounded text-xs">{files.filter(f=>f.category===c).length}</span>
                                        </button>
                                    ))}
                                </aside>
                                <div className="flex-1">
                                    <div className={`grid gap-3 ${viewMode==='grid' ? 'grid-cols-2 md:grid-cols-3 lg:grid-cols-4' : 'grid-cols-1'}`}>
                                        {filtered.map(file => (
                                            <div key={file.id} onClick={()=>setPreviewFile(file)} className={`bg-white border rounded-xl p-3 hover:shadow-md cursor-pointer group relative ${viewMode==='list' ? 'flex items-center gap-4' : ''}`}>
                                                <div className="text-blue-600 bg-blue-50 p-3 rounded-lg shrink-0">
                                                    {file.isLink ? <LinkIcon size={24}/> : <FileText size={24}/>}
                                                </div>
                                                <div className="min-w-0 flex-1">
                                                    <h4 className="font-semibold text-sm truncate text-slate-700" title={file.name}>{file.name}</h4>
                                                    <div className="flex items-center gap-2 mt-1">
                                                        <span className="text-[10px] bg-slate-100 px-2 py-0.5 rounded uppercase text-slate-500">{file.category}</span>
                                                        {file.linkType === 'error' && <span className="text-[10px] text-red-500 font-bold bg-red-50 px-1">Lỗi Link</span>}
                                                    </div>
                                                </div>
                                                <div className="flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity absolute top-2 right-2 bg-white shadow-sm p-1 rounded border z-10" onClick={e=>e.stopPropagation()}>
                                                    <button onClick={(e)=>handleDownload(e, file)} className="p-1.5 hover:bg-slate-100 rounded text-slate-600" title="Tải xuống"><Download size={14}/></button>
                                                    <button onClick={(e)=>{e.stopPropagation(); setEditingFile(file); setModals(m=>({...m, edit:true}))}} className="p-1.5 hover:bg-slate-100 rounded text-blue-600"><Edit2 size={14}/></button>
                                                    {!file.isLink && <button onClick={(e)=>{e.stopPropagation(); setReplacingId(file.id); replaceInputRef.current.click()}} className="p-1.5 hover:bg-slate-100 rounded text-green-600"><RefreshCw size={14}/></button>}
                                                    <button onClick={(e)=>handleDelete(e, file.id)} className="p-1.5 hover:bg-red-50 rounded text-red-600"><Trash2 size={14}/></button>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </>
                        )}
                    </main>

                    {previewFile && <FilePreviewModal file={previewFile} onClose={()=>setPreviewFile(null)}/>}
                    <EditModal file={editingFile} isOpen={modals.edit} onClose={()=>setModals(m=>({...m, edit:false}))} onSave={(id, tag, link) => {
                        setFiles(prev => prev.map(f => f.id===id ? {...f, category: tag.toUpperCase(), url: link, linkType: f.isLink ? analyzeLinkType(link) : f.linkType} : f));
                        setModals(m=>({...m, edit:false}));
                    }}/>
                    <AddLinkModal isOpen={modals.link} onClose={()=>setModals(m=>({...m, link:false}))} onAdd={handleAddLink} onAddBulk={handleAddBulk} onSyncSheet={syncSheet}/>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<ProcessManager />);
    </script>
</body>
</html>
