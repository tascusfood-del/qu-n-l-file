<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trình Quản Lý Quy Trình Cửa Hàng</title>
    
    <!-- 1. Cài đặt Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. Cài đặt React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- 3. Cài đặt Babel để đọc code JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- 4. Cài đặt Lucide Icons (Phiên bản React) -->
    <script src="https://unpkg.com/lucide-react@0.294.0/dist/umd/lucide-react.min.js"></script>

    <style>
        /* Tùy chỉnh thanh cuộn cho đẹp hơn */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        /* Hiệu ứng loading */
        @keyframes fade-in { from { opacity: 0; } to { opacity: 1; } }
        .animate-in { animation: fade-in 0.3s ease-out; }
    </style>
</head>
<body class="bg-slate-50">
    <div id="root"></div>

    <script type="text/babel">
        // Lấy các hook từ React
        const { useState, useEffect, useMemo, useRef } = React;
        
        // Lấy các icon từ thư viện LucideReact đã nhúng
        const { 
            Search, FolderOpen, FileText, Eye, Grid, List, X, Download, 
            Trash2, RefreshCw, Tag, Edit2, Link: LinkIcon, Lock, 
            ExternalLink, ChevronLeft, ChevronRight, Folder, Copy, 
            Table, CheckCircle, AlertTriangle, AlertCircle, FileWarning, RefreshCcw
        } = lucideReact;

        // --- BẮT ĐẦU CODE ỨNG DỤNG ---

        // --- Helper: Login Screen ---
        const LoginScreen = ({ onLogin }) => {
            const [password, setPassword] = useState('');
            const [error, setError] = useState(false);

            const handleLogin = (e) => {
                e.preventDefault();
                if (password === '123456' || password === 'admin') {
                    onLogin();
                } else {
                    setError(true);
                }
            };

            return (
                <div className="fixed inset-0 z-[100] bg-slate-900 flex items-center justify-center p-4">
                    <div className="bg-white w-full max-w-md p-8 rounded-2xl shadow-2xl animate-in">
                        <div className="flex justify-center mb-6">
                            <div className="bg-blue-100 p-4 rounded-full">
                                <Lock className="text-blue-600" size={32} />
                            </div>
                        </div>
                        <h2 className="text-2xl font-bold text-center text-slate-800 mb-2">Đăng nhập hệ thống</h2>
                        <p className="text-center text-slate-500 mb-6">Nhập mật khẩu để truy cập quy trình</p>
                        
                        <form onSubmit={handleLogin} className="space-y-4">
                            <div>
                                <input 
                                    type="password" 
                                    value={password}
                                    onChange={(e) => {setPassword(e.target.value); setError(false);}}
                                    className="w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition"
                                    placeholder="Mật khẩu"
                                    autoFocus
                                />
                                {error && <p className="text-red-500 text-sm mt-2">Mật khẩu không đúng. Vui lòng thử lại.</p>}
                            </div>
                            <button 
                                type="submit"
                                className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg transition shadow-lg shadow-blue-200"
                            >
                                Mở khóa
                            </button>
                        </form>
                        <p className="text-center text-xs text-slate-400 mt-6">Secure Local Process Manager</p>
                    </div>
                </div>
            );
        };

        // --- Helper Functions ---
        const analyzeLinkType = (url) => {
            if (!url || !url.startsWith('http')) return 'error';
            if (url.includes('id=') || url.includes('preview=') || url.includes('open=')) return 'file-link';
            if (url.includes('/folders/') || url.includes('/drive/u/') || url.includes('drive.google.com/drive/folders')) return 'folder-link';
            return 'file-link';
        };

        const getDriveId = (url) => {
            if (!url) return null;
            const idParamMatch = url.match(/[?&]id=([a-zA-Z0-9-_]+)/);
            if (idParamMatch && idParamMatch[1]) return idParamMatch[1];
            const pathIdMatch = url.match(/\/d\/([a-zA-Z0-9-_]+)/);
            if (pathIdMatch && pathIdMatch[1]) return pathIdMatch[1];
            return null;
        };

        // --- Helper: Modal thêm Link ---
        const AddLinkModal = ({ isOpen, onClose, onAdd, onAddBulk, onSyncSheet }) => {
            const [mode, setMode] = useState('single'); 
            const [name, setName] = useState('');
            const [url, setUrl] = useState('');
            const [category, setCategory] = useState('');
            const [bulkText, setBulkText] = useState('');
            const [sheetUrl, setSheetUrl] = useState('');
            const [isFetchingSheet, setIsFetchingSheet] = useState(false);

            if (!isOpen) return null;

            const handleSingleSubmit = () => {
                if (name && url) {
                    if (!url.startsWith('http')) {
                        alert("Đường dẫn (Link) không hợp lệ.");
                        return;
                    }
                    const type = analyzeLinkType(url);
                    onAdd({ 
                        name, 
                        url, 
                        category: category.toUpperCase() || 'LINK',
                        type: type
                    });
                    resetForm();
                    onClose();
                }
            };

            const handleBulkSubmit = () => {
                if (!bulkText.trim()) return;
                const lines = bulkText.split('\n');
                processLines(lines);
                resetForm();
                onClose();
            };

            const parseCSVLine = (text) => {
                const re_value = /(?!\s*$)\s*(?:'([^'\\]*(?:\\[\S\s][^'\\]*)*)'|"([^"\\]*(?:\\[\S\s][^"\\]*)*)"|([^,'"\s\\]*(?:\s+[^,'"\s\\]+)*))\s*(?:,|$)/g;
                const a = [];
                text.replace(re_value, function(m0, m1, m2, m3) {
                    if (m1 !== undefined) a.push(m1.replace(/\\'/g, "'"));
                    else if (m2 !== undefined) a.push(m2.replace(/\\"/g, '"'));
                    else if (m3 !== undefined) a.push(m3);
                    return '';
                });
                if (/,\s*$/.test(text)) a.push('');
                return a;
            };

            const handleSheetSubmit = async () => {
                if (!sheetUrl.trim()) return;
                setIsFetchingSheet(true);

                try {
                    const match = sheetUrl.match(/\/d\/([a-zA-Z0-9-_]+)/);
                    if (!match || match.length < 2) {
                        alert("Link Google Sheet không hợp lệ.");
                        setIsFetchingSheet(false);
                        return;
                    }
                    const sheetId = match[1];
                    const csvUrl = `https://docs.google.com/spreadsheets/d/${sheetId}/export?format=csv`;

                    const response = await fetch(csvUrl);
                    if (!response.ok) {
                        throw new Error("Không thể truy cập file Sheet. Hãy đảm bảo đã Share 'Anyone with the link'.");
                    }

                    const csvText = await response.text();
                    const rows = csvText.split(/\r?\n/);
                    const dataRows = rows.slice(1);
                    
                    const newItems = [];
                    let invalidCount = 0;

                    dataRows.forEach(row => {
                        let cols = parseCSVLine(row);
                        if (!cols || cols.length === 0) cols = row.split(',').map(c => c.trim());

                        if (cols && cols.length >= 3) {
                            const cleanName = cols[0]?.replace(/^"|"$/g, '').trim();
                            const cleanTag = cols[1]?.replace(/^"|"$/g, '').trim();
                            const cleanLink = cols[2]?.replace(/^"|"$/g, '').trim();

                            if (cleanName) {
                                if (!cleanLink || !cleanLink.startsWith('http')) {
                                    invalidCount++;
                                    newItems.push({
                                        id: `l-error-${Date.now()}-${Math.random()}`,
                                        name: cleanName,
                                        url: '', 
                                        originalText: cleanLink,
                                        category: 'LỖI_LINK',
                                        isLink: true,
                                        linkType: 'error',
                                        size: 0,
                                        lastModified: Date.now(),
                                        sourceSheet: sheetUrl
                                    });
                                } else {
                                    const type = analyzeLinkType(cleanLink);
                                    newItems.push({
                                        id: `l-sheet-${Date.now()}-${Math.random()}`,
                                        name: cleanName,
                                        url: cleanLink,
                                        category: (cleanTag || 'SHEET').toUpperCase(),
                                        isLink: true,
                                        linkType: type === 'folder-link' ? 'folder' : 'file',
                                        size: 0,
                                        lastModified: Date.now(),
                                        sourceSheet: sheetUrl
                                    });
                                }
                            }
                        }
                    });

                    if (newItems.length > 0 || dataRows.length === 0) {
                        onSyncSheet(sheetUrl, newItems);
                        if (invalidCount > 0) {
                            alert(`Đã đồng bộ xong! Có ${invalidCount} dòng bị lỗi link trong Sheet.`);
                        } else {
                            alert(`Đã đồng bộ thành công ${newItems.length} quy trình từ Sheet!`);
                        }
                        resetForm();
                        onClose();
                    } 

                } catch (error) {
                    console.error(error);
                    alert(`Lỗi: ${error.message}`);
                } finally {
                    setIsFetchingSheet(false);
                }
            };

            const processLines = (lines) => {
                const newItems = [];
                lines.forEach(line => {
                    const parts = line.split('|').map(p => p.trim());
                    if (parts.length >= 2) {
                        const url = parts[1];
                        if (url.startsWith('http')) {
                            const type = analyzeLinkType(url);
                            newItems.push({
                                id: `l-bulk-${Date.now()}-${Math.random()}`,
                                name: parts[0],
                                url: url,
                                category: (parts[2] || 'NHAP_NHANH').toUpperCase(),
                                isLink: true,
                                linkType: type === 'folder-link' ? 'folder' : 'file',
                                size: 0,
                                lastModified: Date.now()
                            });
                        }
                    }
                });
                onAddBulk(newItems);
            };

            const resetForm = () => {
                setName(''); setUrl(''); setCategory(''); setBulkText(''); setSheetUrl('');
            };

            return (
                <div className="fixed inset-0 z-[60] flex items-center justify-center bg-black/50 backdrop-blur-sm p-4 animate-in">
                    <div className="bg-white w-full max-w-lg rounded-xl shadow-xl overflow-hidden flex flex-col max-h-[90vh]">
                        <div className="flex border-b border-slate-200">
                            <button className={`flex-1 py-3 font-medium text-xs sm:text-sm flex justify-center items-center gap-1 ${mode === 'single' ? 'bg-white text-blue-600 border-b-2 border-blue-600' : 'bg-slate-50 text-slate-500'}`} onClick={() => setMode('single')}><LinkIcon size={14}/> 1 Link</button>
                            <button className={`flex-1 py-3 font-medium text-xs sm:text-sm flex justify-center items-center gap-1 ${mode === 'sheet' ? 'bg-white text-green-600 border-b-2 border-green-600' : 'bg-slate-50 text-slate-500'}`} onClick={() => setMode('sheet')}><Table size={14}/> Google Sheet (Sync)</button>
                            <button className={`flex-1 py-3 font-medium text-xs sm:text-sm flex justify-center items-center gap-1 ${mode === 'bulk' ? 'bg-white text-slate-600 border-b-2 border-slate-600' : 'bg-slate-50 text-slate-500'}`} onClick={() => setMode('bulk')}><Copy size={14}/> Copy Paste</button>
                        </div>

                        <div className="p-6 overflow-y-auto">
                            {mode === 'single' && (
                                <div className="space-y-4">
                                    <div><label className="block text-sm font-medium text-slate-700 mb-1">Tên quy trình</label><input type="text" className="w-full p-2.5 border rounded-lg" value={name} onChange={e => setName(e.target.value)} placeholder="VD: Quy trình Kho" /></div>
                                    <div><label className="block text-sm font-medium text-slate-700 mb-1">Link Drive</label><input type="text" className="w-full p-2.5 border rounded-lg" value={url} onChange={e => setUrl(e.target.value)} placeholder="https://..." /></div>
                                    <div><label className="block text-sm font-medium text-slate-700 mb-1">Tag</label><input type="text" className="w-full p-2.5 border rounded-lg uppercase" value={category} onChange={e => setCategory(e.target.value)} placeholder="VD: KHO" /></div>
                                </div>
                            )}
                            {mode === 'sheet' && (
                                <div className="space-y-4">
                                    <div className="bg-green-50 p-4 rounded-lg border border-green-100 text-sm text-green-800">
                                        <p className="font-bold mb-2 flex items-center gap-2 text-green-700"><RefreshCcw size={16}/> Chế độ Đồng bộ (Sync):</p>
                                        <p className="mb-2">Khi bạn nhập Link Google Sheet vào đây, hệ thống sẽ <strong>xóa tất cả các mục cũ</strong> được nhập từ Sheet này trước đó và thay thế bằng danh sách mới nhất.</p>
                                        <p className="text-xs text-green-700">Điều này giúp danh sách trên web luôn khớp với file Excel của bạn.</p>
                                    </div>
                                    <div><label className="block text-sm font-medium text-slate-700 mb-1">Link Google Sheet:</label><input type="text" className="w-full p-3 border rounded-lg" placeholder="https://docs.google.com/spreadsheets/..." value={sheetUrl} onChange={e => setSheetUrl(e.target.value)}/></div>
                                </div>
                            )}
                            {mode === 'bulk' && (
                                <div className="space-y-4">
                                    <div><label className="block text-sm font-medium text-slate-700 mb-1">Dán text (Tên | Link | Tag)</label><textarea className="w-full p-3 border rounded-lg h-32 font-mono text-sm" placeholder={"Quy trình A | http... | KHO"} value={bulkText} onChange={e => setBulkText(e.target.value)}></textarea></div>
                                </div>
                            )}
                        </div>

                        <div className="p-4 border-t border-slate-100 bg-slate-50 flex justify-end gap-2">
                            <button onClick={onClose} className="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-lg">Hủy</button>
                            {mode === 'single' && <button onClick={handleSingleSubmit} className="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Thêm</button>}
                            {mode === 'sheet' && <button onClick={handleSheetSubmit} disabled={isFetchingSheet} className="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:opacity-50">{isFetchingSheet ? 'Đang đọc & Đồng bộ...' : 'Đồng bộ Ngay'}</button>}
                            {mode === 'bulk' && <button onClick={handleBulkSubmit} className="px-6 py-2 bg-slate-700 text-white rounded-lg hover:bg-slate-800">Nhập Text</button>}
                        </div>
                    </div>
                </div>
            );
        };

        // --- Helper: Edit Modal ---
        const EditModal = ({ file, isOpen, onClose, onSave }) => {
            const [tags, setTags] = useState('');
            const [link, setLink] = useState('');

            useEffect(() => { 
                if (file) {
                    setTags(file.category || ''); 
                    setLink(file.url || '');
                }
            }, [file]);

            if (!isOpen || !file) return null;
            
            return (
                <div className="fixed inset-0 z-[60] flex items-center justify-center bg-black/50 backdrop-blur-sm p-4 animate-in">
                    <div className="bg-white w-full max-w-md rounded-xl shadow-xl p-6">
                        <h3 className="text-lg font-bold mb-4 flex items-center gap-2"><Edit2 size={18}/> Chỉnh sửa thông tin</h3>
                        
                        <div className="mb-4">
                            <label className="block text-xs font-medium text-slate-500 mb-1">Nhóm / Tag</label>
                            <input type="text" value={tags} onChange={(e) => setTags(e.target.value)} className="w-full p-2 border rounded-lg uppercase" />
                        </div>

                        {file.isLink && (
                            <div className="mb-4">
                                <label className="block text-xs font-medium text-slate-500 mb-1">Đường dẫn (Link)</label>
                                <input type="text" value={link} onChange={(e) => setLink(e.target.value)} className="w-full p-2 border rounded-lg text-sm" placeholder="https://..." />
                            </div>
                        )}

                        <div className="flex justify-end gap-2">
                            <button onClick={onClose} className="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-lg">Hủy</button>
                            <button onClick={() => onSave(file.id, tags, link)} className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Lưu</button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- PDF Viewer ---
        const PdfViewer = ({ file }) => {
            const canvasRef = useRef(null);
            const [pdfDoc, setPdfDoc] = useState(null);
            const [pageNum, setPageNum] = useState(1);
            const [scale, setScale] = useState(1.5);
            const [loading, setLoading] = useState(true);
            const [renderError, setRenderError] = useState(null);

            useEffect(() => {
                const loadPdf = async () => {
                    setLoading(true);
                    setRenderError(null);
                    try {
                        if (!window.pdfjsLib) return;
                        window.pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
                        
                        const arrayBuffer = await file.arrayBuffer();
                        const loadingTask = window.pdfjsLib.getDocument({ data: arrayBuffer });
                        const doc = await loadingTask.promise;
                        setPdfDoc(doc); setPageNum(1); setLoading(false);
                    } catch (error) { 
                        console.error(error); 
                        setRenderError("Không thể đọc file PDF này. Có thể file bị lỗi.");
                        setLoading(false); 
                    }
                };
                loadPdf();
            }, [file]);

            useEffect(() => {
                const renderPage = async () => {
                    if (!pdfDoc || !canvasRef.current) return;
                    try {
                        const page = await pdfDoc.getPage(pageNum);
                        const viewport = page.getViewport({ scale });
                        const canvas = canvasRef.current;
                        const context = canvas.getContext('2d');
                        canvas.height = viewport.height; canvas.width = viewport.width;
                        await page.render({ canvasContext: context, viewport: viewport }).promise;
                    } catch (err) { console.error("Render page error", err); }
                };
                renderPage();
            }, [pdfDoc, pageNum, scale]);

            if (loading) return <div className="text-white text-center p-4">Đang tải PDF...</div>;
            if (renderError) return <div className="text-white text-center p-4">{renderError}</div>;

            return (
                <div className="flex flex-col items-center w-full h-full bg-slate-500 overflow-y-auto p-4">
                    <div className="sticky top-0 z-10 bg-slate-800 text-white p-2 rounded-lg mb-4 flex items-center gap-4 shadow-lg">
                        <button disabled={pageNum <= 1} onClick={() => setPageNum(p => p - 1)} className="disabled:opacity-30 hover:bg-slate-700 p-1 rounded"><ChevronLeft/></button>
                        <span className="text-sm">Trang {pageNum}/{pdfDoc?.numPages}</span>
                        <button disabled={pageNum >= pdfDoc?.numPages} onClick={() => setPageNum(p => p + 1)} className="disabled:opacity-30 hover:bg-slate-700 p-1 rounded"><ChevronRight/></button>
                        <div className="w-px h-4 bg-slate-600"></div>
                        <button onClick={() => setScale(s => Math.max(0.5, s - 0.2))} className="px-2 hover:bg-slate-700 rounded">-</button>
                        <span className="text-xs">{Math.round(scale * 100)}%</span>
                        <button onClick={() => setScale(s => Math.min(3, s + 0.2))} className="px-2 hover:bg-slate-700 rounded">+</button>
                    </div>
                    <canvas ref={canvasRef} className="shadow-2xl rounded-sm max-w-full" />
                </div>
            );
        };

        // --- Core: File Preview Modal ---
        const FilePreviewModal = ({ file, onClose }) => {
            const containerRef = useRef(null);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);

            const getEmbedUrl = (url) => {
                if (!url || !url.startsWith('http')) return null;
                const fileId = getDriveId(url);
                if (!fileId && (url.includes('/folders/') || url.includes('drive.google.com/drive/u/'))) return null;
                if (fileId) {
                    if (url.includes('spreadsheets')) return `https://docs.google.com/spreadsheets/d/${fileId}/preview`;
                    if (url.includes('document')) return `https://docs.google.com/document/d/${fileId}/preview`;
                    if (url.includes('presentation')) return `https://docs.google.com/presentation/d/${fileId}/preview`;
                    return `https://drive.google.com/file/d/${fileId}/preview`;
                }
                return url.replace(/\/view.*$/, '/preview').replace(/\/edit.*$/, '/preview').replace(/\/open.*$/, '/preview').replace(/\/copy.*$/, '/preview');
            };

            const embedUrl = file.isLink ? getEmbedUrl(file.url) : null;
            const isFolderLink = file.isLink && (file.linkType === 'folder' || !embedUrl); 
            const isBrokenLink = file.isLink && !file.url; 

            useEffect(() => {
                if (!file) return;
                if (file.isLink) { setLoading(false); return; }
                setLoading(true); setError(null);
                const renderFile = async () => {
                    try {
                        const extension = file.name.split('.').pop().toLowerCase();
                        if (extension === 'pdf' || file.name.endsWith('.pdf')) { setLoading(false); return; }
                        if (extension === 'docx') {
                            if (!window.docx) throw new Error("Thư viện DOCX lỗi.");
                            if (containerRef.current) containerRef.current.innerHTML = '';
                            await window.docx.renderAsync(file, containerRef.current, null, { inWrapper: false, ignoreWidth: false, experimental: true, breakPages: true, useBase64URL: true });
                            setLoading(false); return;
                        }
                        if (['xlsx', 'xls', 'csv'].includes(extension)) {
                            if (!window.XLSX) throw new Error("Thư viện Excel lỗi.");
                            const reader = new FileReader();
                            reader.onload = (e) => {
                                const data = new Uint8Array(e.target.result);
                                const workbook = window.XLSX.read(data, {type: 'array'});
                                const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                                const html = window.XLSX.utils.sheet_to_html(worksheet, { id: "excel-table" });
                                if (containerRef.current) containerRef.current.innerHTML = `<div style="padding:20px; overflow:auto; background:white;">${html}</div>`;
                                setLoading(false);
                            };
                            reader.readAsArrayBuffer(file); return;
                        }
                        throw new Error("Không hỗ trợ preview.");
                    } catch (err) { setError(err.message); setLoading(false); }
                };
                setTimeout(renderFile, 100);
            }, [file]);

            if (!file) return null;
            const isPdf = file.name?.toLowerCase().endsWith('.pdf');

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/80 p-4 animate-in">
                    <div className="bg-white w-full h-full max-w-[95vw] max-h-[95vh] rounded-xl shadow-2xl flex flex-col overflow-hidden">
                        <div className="flex items-center justify-between px-4 py-3 bg-slate-100 border-b border-slate-200 shrink-0">
                            <h3 className="font-bold text-slate-800 truncate max-w-md flex items-center gap-2">
                                {file.isLink && <ExternalLink size={16} className="text-blue-600"/>}
                                {file.name || "Không tên"}
                            </h3>
                            <div className="flex items-center gap-2">
                                {file.isLink && !isBrokenLink && (
                                    <a href={file.url} target="_blank" rel="noopener noreferrer" className="px-3 py-1.5 bg-blue-100 hover:bg-blue-200 text-blue-700 rounded-lg text-sm font-medium flex items-center gap-1">
                                        <ExternalLink size={14} /> Mở Tab Mới
                                    </a>
                                )}
                                {!file.isLink && (
                                    <a href={URL.createObjectURL(file)} download={file.name} className="p-2 hover:bg-slate-200 rounded-lg text-slate-600 flex items-center gap-1">
                                        <Download size={18} /> <span className="hidden sm:inline">Tải về</span>
                                    </a>
                                )}
                                <button onClick={onClose} className="p-2 hover:bg-red-100 text-slate-500 hover:text-red-600 rounded-lg"><X size={22} /></button>
                            </div>
                        </div>
                        <div className="flex-1 bg-slate-200 relative overflow-hidden flex flex-col">
                            {loading && !isPdf && !file.isLink && <div className="absolute inset-0 flex items-center justify-center bg-white/50 z-10"><div className="w-8 h-8 border-4 border-blue-600 border-t-transparent rounded-full animate-spin"></div></div>}
                            {file.isLink ? (
                                isBrokenLink ? <div className="flex flex-col items-center justify-center h-full text-center p-8 bg-red-50"><FileWarning size={48} className="text-red-500 mb-4" /><h3 className="text-xl font-bold text-red-700 mb-2">Đường dẫn bị lỗi</h3></div> : 
                                isFolderLink ? <div className="flex flex-col items-center justify-center h-full text-center p-8"><div className="bg-yellow-50 p-6 rounded-full mb-4"><Folder size={48} className="text-yellow-600" /></div><h3 className="text-xl font-bold text-slate-800 mb-2">Đường dẫn Thư mục</h3><a href={file.url} target="_blank" rel="noopener noreferrer" className="bg-blue-600 text-white px-6 py-3 rounded-lg font-medium hover:bg-blue-700 transition flex items-center gap-2"><ExternalLink size={20} /> Mở Thư mục</a></div> : 
                                <div className="w-full h-full bg-white relative"><iframe src={embedUrl} className="w-full h-full border-none" title="Live Preview" allow="autoplay"></iframe></div>
                            ) : error ? <div className="flex flex-col items-center justify-center h-full text-center p-4"><p className="text-red-500">{error}</p></div> : isPdf ? <PdfViewer file={file} /> : <div ref={containerRef} className="w-full h-full overflow-y-auto bg-slate-100 flex justify-center docx-wrapper" style={{ padding: '20px' }}></div>}
                        </div>
                    </div>
                </div>
            );
        };

        // --- Main Component ---
        const ProcessManager = () => {
            const [isAuthenticated, setIsAuthenticated] = useState(false);
            const [files, setFiles] = useState([]);
            const [searchQuery, setSearchQuery] = useState('');
            const [viewMode, setViewMode] = useState('list');
            const [previewFile, setPreviewFile] = useState(null);
            const [activeCategory, setActiveCategory] = useState('all');
            
            const [editModalOpen, setEditModalOpen] = useState(false);
            const [linkModalOpen, setLinkModalOpen] = useState(false);
            const [editingFile, setEditingFile] = useState(null);
            const replaceInputRef = useRef(null);
            const [replacingFileId, setReplacingFileId] = useState(null);

            // Load các thư viện phụ thuộc
            useEffect(() => {
                const libraries = [
                    "https://unpkg.com/jszip/dist/jszip.min.js", 
                    "https://unpkg.com/docx-preview/dist/docx-preview.min.js", 
                    "https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js", 
                    "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"
                ];
                libraries.forEach(src => { 
                    const script = document.createElement('script'); 
                    script.src = src; 
                    document.body.appendChild(script); 
                });
            }, []);

            const guessCategory = (filename) => {
                let category = 'CHUNG';
                const parts = filename.split(/[_\-\s]/);
                if (parts.length > 1) category = parts[0].toUpperCase();
                return category.replace(/[^a-zA-Z0-9À-ỹ]/g, "").substring(0, 10) || 'KHÁC';
            };

            const mergeNewFiles = (newFilesList) => {
                setFiles(prev => {
                    const nextFiles = [...prev];
                    newFilesList.forEach(newFile => {
                        const index = nextFiles.findIndex(f => (newFile.isLink && f.isLink && f.url === newFile.url) || (!newFile.isLink && !f.isLink && f.name === newFile.name));
                        if (index !== -1) {
                            nextFiles[index] = { ...newFile, id: nextFiles[index].id, category: newFile.category === 'KHÁC' || newFile.category === 'CHUNG' ? nextFiles[index].category : newFile.category };
                        } else {
                            nextFiles.push(newFile);
                        }
                    });
                    return nextFiles;
                });
            };

            const syncSheetFiles = (sheetUrl, newItems) => {
                setFiles(prev => {
                    const cleanedFiles = prev.filter(f => f.sourceSheet !== sheetUrl);
                    return [...cleanedFiles, ...newItems];
                });
            };

            const handleFileUpload = (event) => {
                const uploadedFiles = Array.from(event.target.files).filter(file => ['docx', 'doc', 'pdf', 'xlsx', 'xls', 'csv'].includes(file.name.split('.').pop().toLowerCase()));
                const filesWithId = uploadedFiles.map((file, index) => {
                    file.id = `f-${Date.now()}-${index}`;
                    file.category = guessCategory(file.name);
                    return file;
                });
                mergeNewFiles(filesWithId);
            };

            const handleAddLink = (linkData) => {
                mergeNewFiles([{ id: `l-${Date.now()}`, ...linkData, isLink: true, size: 0, lastModified: Date.now() }]);
            };
            
            const handleAddBulk = (newItems) => mergeNewFiles(newItems);

            const handleDelete = (e, fileId) => {
                e.preventDefault(); e.stopPropagation(); 
                if (window.confirm('Bạn có chắc chắn muốn xóa quy trình này?')) {
                    setFiles(prev => prev.filter(f => f.id !== fileId));
                    if (previewFile && previewFile.id === fileId) setPreviewFile(null);
                }
            };

            const handleSaveEdit = (id, tag, link) => {
                setFiles(prev => prev.map(f => f.id === id ? {...f, category: tag ? tag.toUpperCase().trim() : 'CHUNG', url: link ? link.trim() : '', linkType: (f.isLink && link) ? analyzeLinkType(link) : f.linkType} : f));
                setEditModalOpen(false); setEditingFile(null);
            };

            const handleReplaceFile = (event) => {
                const newFile = event.target.files[0];
                if (!newFile || !replacingFileId) return;
                setFiles(prev => prev.map(f => f.id === replacingFileId ? { ...newFile, id: f.id, category: f.category } : f));
                setReplacingFileId(null); event.target.value = null; alert("Đã thay thế nội dung file thành công!");
            };

            const handleDownload = (e, file) => {
                e.stopPropagation();
                if (file.isLink) {
                    const fileId = getDriveId(file.url);
                    if (fileId) {
                        window.open(`https://drive.google.com/uc?export=download&id=${fileId}`, '_blank');
                    } else {
                        window.open(file.url, '_blank');
                    }
                } else {
                    const url = URL.createObjectURL(file);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = file.name;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                }
            };

            const filteredFiles = useMemo(() => {
                return files.filter(file => {
                    const matchesSearch = file.name?.toLowerCase().includes(searchQuery.toLowerCase());
                    const matchesCategory = activeCategory === 'all' || file.category === activeCategory;
                    return matchesSearch && matchesCategory;
                });
            }, [files, searchQuery, activeCategory]);

            const categories = useMemo(() => {
                const cats = new Set(files.map(f => f.category));
                return ['all', ...Array.from(cats).sort()];
            }, [files]);

            const getFileIcon = (file) => {
                if (file.isLink) {
                    if (file.linkType === 'error') return <AlertTriangle className="text-red-500" size={viewMode === 'list' ? 20 : 28} />;
                    if (file.linkType === 'folder') return <Folder className="text-yellow-500" size={viewMode === 'list' ? 20 : 28} />;
                    return <LinkIcon className="text-purple-600" size={viewMode === 'list' ? 20 : 28} />;
                }
                const ext = file.name.split('.').pop().toLowerCase();
                if (ext === 'pdf') return <FileText className="text-red-500" size={viewMode === 'list' ? 20 : 28} />;
                if (['xlsx', 'xls', 'csv'].includes(ext)) return <FileSpreadsheet className="text-green-600" size={viewMode === 'list' ? 20 : 28} />;
                return <FileText className="text-blue-600" size={viewMode === 'list' ? 20 : 28} />;
            };

            if (!isAuthenticated) return <LoginScreen onLogin={() => setIsAuthenticated(true)} />;

            return (
                <div className="min-h-screen bg-slate-50 text-slate-800 font-sans">
                    <input type="file" ref={replaceInputRef} className="hidden" onChange={handleReplaceFile} accept=".docx,.pdf,.xlsx,.xls,.csv"/>

                    <header className="bg-white border-b border-slate-200 sticky top-0 z-30 shadow-sm">
                        <div className="max-w-7xl mx-auto px-4 h-16 flex items-center justify-between gap-4">
                            <div className="flex items-center gap-2">
                                <div className="bg-blue-600 text-white p-2 rounded-lg"><FileText size={20} /></div>
                                <h1 className="text-lg font-bold hidden md:block">Quản Lý Quy Trình (Admin)</h1>
                            </div>

                            <div className="flex-1 max-w-2xl relative">
                                <Search className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" size={18} />
                                <input type="text" placeholder="Tìm kiếm..." className="w-full pl-10 pr-4 py-2 bg-slate-100 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" value={searchQuery} onChange={(e) => setSearchQuery(e.target.value)} />
                            </div>

                            <div className="flex items-center gap-2">
                                <button onClick={() => setLinkModalOpen(true)} className="bg-purple-100 text-purple-700 hover:bg-purple-200 px-3 py-2 rounded-lg text-sm font-medium flex items-center gap-2 border border-purple-200">
                                    <LinkIcon size={16}/> <span className="hidden sm:inline">Thêm Link / Sheet</span>
                                </button>
                                <label className="cursor-pointer bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded-lg text-sm font-medium flex items-center gap-2 shadow-sm">
                                    <FolderOpen size={16} /> <span className="hidden sm:inline">Chọn Folder PC</span>
                                    <input type="file" webkitdirectory="true" directory="true" multiple className="hidden" onChange={handleFileUpload}/>
                                </label>
                                <div className="flex bg-slate-100 p-1 rounded-lg ml-2">
                                    <button onClick={() => setViewMode('list')} className={`p-1.5 rounded ${viewMode === 'list' ? 'bg-white shadow text-blue-600' : 'text-slate-500'}`}><List size={18}/></button>
                                    <button onClick={() => setViewMode('grid')} className={`p-1.5 rounded ${viewMode === 'grid' ? 'bg-white shadow text-blue-600' : 'text-slate-500'}`}><Grid size={18}/></button>
                                </div>
                            </div>
                        </div>
                    </header>

                    <main className="max-w-7xl mx-auto px-4 py-6">
                        {files.length === 0 ? (
                            <div className="flex flex-col items-center justify-center h-[60vh] text-slate-400">
                                <div className="bg-white p-8 rounded-2xl shadow-lg border border-slate-100 text-center max-w-lg">
                                    <Lock className="w-12 h-12 text-blue-500 mx-auto mb-4" />
                                    <h2 className="text-xl font-bold text-slate-800">Hệ thống sẵn sàng</h2>
                                    <div className="text-sm text-left bg-slate-50 p-4 rounded-lg border border-slate-200 mb-6 space-y-2">
                                        <p className="flex items-start gap-2"><FolderOpen size={16} className="text-blue-600 shrink-0 mt-0.5"/> <strong>Cách 1:</strong> Chọn Folder từ máy tính (Nếu đã cài Google Drive Desktop, hãy chọn ổ G:). Tự động quét file.</p>
                                        <p className="flex items-start gap-2"><Table size={16} className="text-green-600 shrink-0 mt-0.5"/> <strong>Cách 2:</strong> Nhập link Google Sheet (Cột A: Tên, B: Tag, C: Link) để đồng bộ hàng loạt.</p>
                                    </div>
                                    <div className="flex justify-center gap-3">
                                        <label className="cursor-pointer bg-blue-600 text-white px-6 py-2 rounded-lg font-bold hover:bg-blue-700 transition">
                                            Chọn Folder (G:)
                                            <input type="file" webkitdirectory="true" directory="true" multiple className="hidden" onChange={handleFileUpload}/>
                                        </label>
                                        <button onClick={() => setLinkModalOpen(true)} className="bg-green-100 text-green-700 px-6 py-2 rounded-lg font-bold hover:bg-green-200 flex items-center gap-2">
                                            <LinkIcon size={18}/> Thêm Link / Sheet
                                        </button>
                                    </div>
                                </div>
                            </div>
                        ) : (
                            <div className="flex flex-col md:flex-row gap-6 items-start">
                                <aside className="w-full md:w-56 shrink-0 sticky top-24 bg-white rounded-xl shadow-sm border border-slate-200 p-3">
                                    <h3 className="font-bold text-slate-700 mb-3 px-2 flex items-center gap-2"><Tag size={16}/> Phân loại</h3>
                                    <div className="flex flex-wrap md:flex-col gap-1 max-h-[70vh] overflow-y-auto custom-scrollbar">
                                        {categories.map(cat => (
                                            <button key={cat} onClick={() => setActiveCategory(cat)} 
                                                className={`text-left px-3 py-2 rounded-lg text-sm flex justify-between ${activeCategory === cat ? 'bg-blue-600 text-white' : 'hover:bg-slate-100'}`}
                                            >
                                                <span className="truncate w-32">{cat === 'all' ? 'Tất cả' : cat}</span>
                                                <span className="opacity-70 text-xs bg-black/10 px-1.5 rounded">{files.filter(f => f.category === cat).length}</span>
                                            </button>
                                        ))}
                                    </div>
                                </aside>

                                <div className="flex-1 min-w-0">
                                    <div className="mb-4 text-sm text-slate-500 flex justify-between items-center">
                                        <span>Tìm thấy <b>{filteredFiles.length}</b> kết quả</span>
                                        {activeCategory !== 'all' && <span className="bg-blue-100 text-blue-700 px-2 py-0.5 rounded text-xs">Lọc theo: {activeCategory}</span>}
                                    </div>

                                    <div className={viewMode === 'grid' ? "grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4" : "flex flex-col gap-2"}>
                                        {filteredFiles.map((file) => (
                                            <div key={file.id} onClick={() => setPreviewFile(file)}
                                                className={`group bg-white border border-slate-200 hover:border-blue-500 hover:shadow-md transition cursor-pointer rounded-lg relative ${viewMode === 'list' ? 'flex items-center p-3 gap-4' : 'p-4 flex flex-col gap-3'}`}
                                            >
                                                <div className={`flex items-center justify-center rounded-lg bg-slate-50 shrink-0 ${viewMode === 'list' ? 'w-10 h-10' : 'w-12 h-12 self-start'}`}>
                                                    {getFileIcon(file)}
                                                </div>

                                                <div className="flex-1 min-w-0">
                                                    <h4 className={`font-semibold text-sm truncate ${file.linkType === 'error' ? 'text-red-600' : 'text-slate-800'}`} title={file.name}>
                                                        {file.name || "Không tên"}
                                                    </h4>
                                                    <div className="flex items-center gap-2 text-xs text-slate-500 mt-1">
                                                        <span className={`px-2 py-0.5 rounded uppercase ${file.linkType === 'error' ? 'bg-red-100 text-red-700' : 'bg-slate-100'}`}>
                                                            {file.category}
                                                        </span>
                                                        {file.isLink ? (
                                                            file.linkType === 'error' ? <span className="text-red-500 font-bold">Lỗi Link</span> : <span className="text-purple-600 flex items-center gap-0.5"><ExternalLink size={10}/> Online</span>
                                                        ) : <span>{(file.size/1024).toFixed(0)} KB</span>}
                                                    </div>
                                                </div>

                                                <div className={`flex items-center gap-1 ${viewMode !== 'list' && 'absolute top-2 right-2 opacity-0 group-hover:opacity-100'} transition bg-white/95 p-1 rounded shadow-sm z-20`}>
                                                    <button 
                                                        onClick={(e) => handleDownload(e, file)} 
                                                        className="p-1.5 hover:bg-slate-100 rounded text-slate-600"
                                                        title="Tải xuống"
                                                    >
                                                        <Download size={16}/>
                                                    </button>
                                                    <button 
                                                        onClick={(e) => { e.stopPropagation(); setEditingFile(file); setEditModalOpen(true); }} 
                                                        className="p-1.5 hover:bg-slate-100 rounded text-blue-600"
                                                        title="Sửa"
                                                    >
                                                        <Edit2 size={16}/>
                                                    </button>
                                                    {!file.isLink && (
                                                        <button 
                                                            onClick={(e) => { e.stopPropagation(); setReplacingFileId(file.id); replaceInputRef.current.click(); }} 
                                                            className="p-1.5 hover:bg-slate-100 rounded text-green-600"
                                                            title="Thay file"
                                                        >
                                                            <RefreshCw size={16}/>
                                                        </button>
                                                    )}
                                                    <button 
                                                        onClick={(e) => handleDelete(e, file.id)}
                                                        className="p-1.5 hover:bg-red-50 rounded text-red-600"
                                                        title="Xóa"
                                                    >
                                                        <Trash2 size={16}/>
                                                    </button>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        )}
                    </main>

                    {previewFile && <FilePreviewModal file={previewFile} onClose={() => setPreviewFile(null)} />}
                    
                    <EditModal 
                        file={editingFile} 
                        isOpen={editModalOpen} 
                        onClose={() => setEditModalOpen(false)} 
                        onSave={handleSaveEdit} 
                    />
                    
                    <AddLinkModal 
                        isOpen={linkModalOpen} 
                        onClose={() => setLinkModalOpen(false)} 
                        onAdd={handleAddLink} 
                        onAddBulk={handleAddBulk}
                        onSyncSheet={syncSheetFiles}
                    />
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<ProcessManager />);
    </script>
</body>
</html>
